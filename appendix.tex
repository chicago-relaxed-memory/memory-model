\section{Proof of DRF}\label{drfproof}

In this section of the appendix, we develop a proof of DRF.  In this section, we first develop closure conditions on semantics.  Next, we prove DRF.

\subsection{Closure properties}

We say that $\aPS' = \aPS\restrict{\Event'}$ when 
 $\Event' \subseteq \Event$,
 ${\labeling'} = {\labeling}\restrict{\Event'}$, 
 ${\le'} = {\le}\restrict{\Event'}$, and
 ${\gtN'} = {\gtN}\restrict{\Event'}$.

\begin{definition}
Let $(\aPS \after \aEv) = {\{ \bEv\in\Event \mid \aEv \le \bEv
  \}}$ be the set of events that follow $\aEv$ in $\aPS$.
\end{definition}

The semantics of read is ``input''-enabled, since it permits the read of any visible value.   Thus, any racy read in a program can be replaced by a read of a earlier value (wrt $\reco$), even while  the races with existing independent writes are maintained.   A canonical example to keep in mind for this lemma is the program:
\begin{align*}
\mbox{Thread 1: } &\VAR y\GETS 0 \SEMI \aReg \GETS y  \SEMI x \GETS 1  \SEMI \\[-.5ex]
\mbox{Thread 2: } &\VAR x\GETS 0 \SEMI \bReg \GETS x \SEMI y \GETS 1  \SEMI 
\end{align*}
with both registers getting value $1$ via the execution:
\begin{tikzdisplay}[node distance=1em]
\event{wy0}{\DW{y}{0}}{}
\event{ry1}{\DR{y}{1}}{right=of wy0}
\event{wx1}{\DW{x}{1}}{right=of ry1}
\event{wx0}{\DW{x}{0}}{below=of wy0}
\event{rx1}{\DR{x}{1}}{right=of wx0}
\event{wy1}{\DW{y}{1}}{right=of rx1}
\rf{wx1}{rx1}
\rf{wy1}{ry1}
\wk{wx0}{rx1}
\wk{wy0}{ry1}
\end{tikzdisplay}
The lemma constructs the execution:
\begin{tikzdisplay}[node distance=1em]
\event{wy0}{\DW{y}{0}}{}
\event{ry1}{\DR{y}{0}}{right=of wy0}
\event{wx1}{\DW{x}{1}}{right=of ry1}
\event{wx0}{\DW{x}{0}}{below=of wy0}
\event{rx1}{\DR{x}{0}}{right=of wx0}
\event{wy1}{\DW{y}{1}}{right=of rx1}
\rf{wx0}{rx1}
\rf{wy0}{ry1}
\wk{rx1}{wx1}
\wk{ry1}{wy1}
\end{tikzdisplay}


\begin{lemma}\label{inputen}
%Let $\aCmd = \vec{\aLoc}\GETS\vec{0}\SEMI \FENCE\SEMI (\aCmd^1 \PAR \cdots \PAR \aCmd^n)$.
Let $\aCmd$ have an initial value for $\aLoc$.   
Let $\aPS \in \sem{\aCmd}$.  
Let $\aEv \in \aPS$ read from write event $\bEv$  on $\aLoc \in \vec{\aLoc}$.  Let $\neg(\bEv \xhb \aEv)$ in $\aPS$. 
Then, there exists $\bPS \in \sem{\aCmd}$ such that:
\begin{itemize}
%\item $(\exists \aEv' \in \Event_{\bPS})$ such that $
%\Event_{\bPS}$ is the disjoint union of  $\Event_{\aPS} \setminus  
%(\aPS \after \aEv))$ and $(\bPS \after \aEv')$.
\item $\aEv'$ reads from $\aLoc$, with matching write event $\bEv'$, such that $\bEv' \xeco \bEv$ in $\bPS$
\item The restriction of $\le$ (resp. $\gtN$) in $\aPS$ to $\Event_{\aPS} \setminus  (\aPS \after \aEv)$ agrees with the the restriction of $\le$ (resp. $\gtN$) in $\bPS$ to $\Event_{\bPS} \setminus  (\aPS \after \aEv)$  in  $\bPS$.  
\end{itemize}
\end{lemma}
\begin{proof}
The key observation behind the proof is that change in a  prefixing read action can only affect the events that are dependent, ie. in the $\lt$ order to the read action.  

The form of the command in the hypothesis of the proof initializes the locations in $\vec{\aLoc}$, thus  ensuring that there is always a value visible to be read. 
\end{proof}
In particular, in the above lemma, $\bEv,\bEv'$ are events of both $\aPS$ and $\bPS$, and  $\bPS$ continues to witness the race of $\aEv', \bEv$ in $\bPS$.   

In the following lemma,  invert the $\reco$ relationship between a read and a write.   A canonical example to keep in mind for this lemma is the program:
\begin{align*}
\mbox{Thread 1: } &\VAR y\GETS 0 \SEMI   x \GETS 1  \SEMI \aReg \GETS y  \SEMI \\[-.5ex]
\mbox{Thread 2: } &\VAR x\GETS 0 \SEMI  y \GETS 1  \SEMI  \bReg \GETS x \SEMI
\end{align*}
with both registers getting value $0$ via the execution:
\begin{tikzdisplay}[node distance=1em]
\event{wy0}{\DW{y}{0}}{}
\event{wx1}{\DW{x}{1}}{right=of wy0}
\event{ry0}{\DR{y}{0}}{right=of wx1}
\event{wx0}{\DW{x}{0}}{below=of wy0}
\event{wy1}{\DW{y}{1}}{right=of wx0}
\event{rx0}{\DR{x}{0}}{right=of wy1}
\rf[bend right]{wx0}{rx0}
\rf[bend left]{wy0}{ry0}
\wk{rx0}{wx1}
\wk{ry0}{wy1}
\wk{wx0}{wx1}
\wk{wy0}{wy1}
\end{tikzdisplay}
The lemma constructs the execution:
\begin{tikzdisplay}[node distance=1em]
\event{wy0}{\DW{y}{0}}{}
\event{wx1}{\DW{x}{1}}{right=of wy0}
\event{ry0}{\DR{y}{1}}{right=of wx1}
\event{wx0}{\DW{x}{0}}{below=of wy0}
\event{wy1}{\DW{y}{1}}{right=of wx0}
\event{rx0}{\DR{x}{1}}{right=of wy1}
\rf{wx1}{rx0}
\rf{wy1}{ry0}
\wk{wx0}{wx1}
\wk{wy0}{wy1}
\end{tikzdisplay}



\begin{lemma}\label{removerw}
Let $\aPS \in \sem{\aCmd}$.   
Let $\bEv \in \aPS$ be a write on $\aLoc$. 
Let $\aEv \in \aPS$ read from $\aLoc \in \vec{\aLoc}$ such that $\aEv \xeco \bEv$ and $\neg(\aEv \lt \bEv)$.  Then, there exists $\bPS \in \sem{\aCmd}$ such that:
\begin{itemize}
%\item $(\exists \aEv' \in \Event_{\bPS})$ such that $
%\Event_{\bPS}$ is the disjoint union of  $\Event_{\aPS} \setminus  
%(\aPS\ \after\ \aEv))$ and $(\bPS\ \after\ \aEv')$.
\item $\aEv' \in \bPS \setminus \aPS$ reads from $\aLoc$, with matching write $\bEv$.
\item The restriction of $\le$ (resp. $\gtN$) in $\aPS$ to $\Event_{\aPS} \setminus (\aPS\ \after\ \aEv)$ agrees with the the restriction of $\le$ (resp. $\gtN$) in $\bPS$ to $\Event_{\bPS} \setminus  (\aPS\ \after\ \aEv)$.  
\end{itemize}
\end{lemma}
\begin{proof}
The proof proceeds similar to the above proof; in this case, replace the value read in $\aEv$ to come from $\bEv$.  
\end{proof}
Any new  event $\bEv'$ in $\bPS \after \aEv'$ reading from $\aLoc$ cannot have a matching write event $\bEv'' \xeco \bEv$ since that  implies $\bEv' \xeco \bEv$ and a $\reco$ cycle $\bEv \lt \aEv \lt \aEv' \xeco \bEv$.  Thus, the above lemma can be iterated if the new pomset is has any further reads that precede $\bEv$ in $\reco$, so we can finally derive a pomset with no reads and writes satisfying the hypothesis of the lemma.   

The $\reco$ order between writes that are not related by $\lt$ can be reversed. 
A canonical example to keep in mind for this lemma is the program:
\begin{align*}
\mbox{Thread 1: } &\VAR x\GETS 1 \\[-.5ex]
\mbox{Thread 2: } &\VAR x\GETS 0 
\end{align*}
with both registers getting value $0$ via the execution:
\begin{tikzdisplay}[node distance=1em]
\event{wy0}{\DW{x}{1}}{}
\event{wx0}{\DW{x}{0}}{below=of wx0}
\wk{wy0}{wx0}
\end{tikzdisplay}
The lemma constructs the execution:
\begin{tikzdisplay}[node distance=1em]
\event{wy0}{\DW{x}{1}}{}
\event{wx0}{\DW{x}{0}}{below=of wx0}
\wk{wx0}{wy0}
\end{tikzdisplay}
\begin{lemma}\label{cohww}
Let $\aPS \in \sem{\aCmd}$.  Let $\bEv, \aEv$ be a writes to $\aLoc$ such that:
\begin{itemize}
\item $\bEv\gtN \aEv$  
\item forall writes $\cEv$ to $\aLoc$ such that  $ \bEv \gtN \cEv \gtN  \aEv$,  it is the case that  $ \neg(\cEv \lt \aEv)$ and $\neg(\cEv \xpox \aEv)$
\end{itemize}

Then, there exists $\bPS \in \sem{\aCmd}$ such that $\Event_{\aPS} = \Event_{\bPS}$, $\le_{\aPS} = \le_{\bPS}$,
and $\aEv \gtN \bEv$ in $\bPS$.
\end{lemma}
\begin{proof}
We show how to interchange $\aEv, \bEv$ adjacent in $\gtN$, ie. we assume that  $\neg(\exists \cEv) \  \bEv \gtN \cEv \gtN \aEv$.  The full proof follows by induction.

Since  $\sem{\aCmd}$ is augmentation closed, it suffices to show that we can build $\bPS$ while satisfying the constraints between $\lt,\gtN$.  We list the changes below.
\begin{itemize}
\item $\aEv \gtN \bEv$ in $\bPS$
\item Forall reads $\cEv$ matched to $\aEv$, change from $\bEv \gtN \cEv$ in $\aPS$ to $\cEv \gtN \bEv$ in $\bPS$
\item Forall reads $\cEv$ matched to $\bEv$, change from $\cEv \gtN \aEv$ in $\aPS$ to $\aEv \gtN \cEv$ in $\bPS$
\end{itemize}

\end{proof}


\subsection{DRF Proof}
In the rest of this section, we assume that $\aPS$ is a generator for
$\aCmd$, as defined in \textsection\ref{sec:sc}.

We prove:
\begin{description}
\item[DRF1: ] If $\aPS$ does not have a race, $\aPS \in \semsc{\aCmd}$. 
\item[DRF2: ] If $\aPS$ has a race, then there exists $\bPS\in \semClosed{\aCmd}$ such that $\bPS \in \semsc{\aCmd}$ and has a race.
\end{description}

\paragraph*{Proof of DRF1}
We first show that if $\aPS$ is not \Seq, then $\aPS$ has a race.  By assumption, there is a cycle in  $\rpox \cup \lt \cup \xeco$.  Let this cycle be $\aEv_0, \aEv'_0, \aEv_1, \aEv'_1, \ldots, \aEv_n, \aEv'_n, \aEv_0$ where for all $i$, $\aEv_i \xpox \aEv'_i$ and $\aEv'_i  \not\xpox \aEv'_{i+1}$.
If for all $i$, $\aEv'_i  \xhb \aEv'_{i+1}$, then the above is a cycle in $\rhb$, which is a contradiction.
So, there is at least one $i$ such that $\aEv'_i  \not\xhb \aEv'_{i+1}$.  There are two cases to consider.
\begin{itemize}
\item $\aEv'_i  \xeco \aEv'_{i+1}$.   In this case, there is a race.
\item  $\aEv'_i  \lt \aEv'_{i+1}$.  In this case, $\aEv'_i$ is a write and $\aEv'_{i+1}$ is a conflicting read, so there is a race. 
\end{itemize}


\paragraph*{Proof of DRF2}

We define a size $|\aPS|$ as follows: $\size(\aPS)$ is the number of events in $\aPS$.    Since we are considering loop free programs, there is an $\aPS \in \sem{\aCmd}$ with maximum size, which we identify as $\size(\aCmd)$.  

We prove by induction on $\size(\aCmd) - \size(\bPS)$ that given $(\aPS, \bPS)$ such that:
\begin{itemize}
\item $\bPS$ is \Seq\ 
\item $\bPS$ is a prefix of $\aPS$ under all of $\xpox,\gtN,\lt$ 
\item $\aPS$ has a race
\end{itemize}
there exists $\bPS\in \sem{\aCmd}$ that demonstrates the race.

The required theorem follows by setting $\bPS$ to be the empty pomset.

For the base case, $\bPS = |\aPS|$.  In this case, $\aPS$ is the required witness.

Otherwise, consider a maximal \Seq\ prefix, extending $\bPS$, wrt to all of  $\rpox,\reco,\lt$.  If it strictly contains $\bPS$, result follows from induction hypothesis.  

If not, $\bPS$ is already maximal.  Consider the set of all events in $\aPS \setminus \bPS$ that are minimal wrt $\rhb$.  In particular, these events will also be minimal wrt $\rpox$.  

If one of these events, say $\aEv$  is a write, we proceed as follows.   Using lemma~\ref{pargen} and $\rhb$-minimality of $\aEv$, we deduce that $\aEv$ is $\lt$-minimal .  Using lemma~\ref{removerw}, we build $\aPS_1$ from $\aPS$ without changing $\bPS$ to ensure that there are is no read $\bEv \in \aPS_1 \setminus \bPS$ such that $\bEv \xeco \aEv$.  Using lemma~\ref{cohww}, we build $\aPS_2$ from $\aPS_1$ without changing $\bPS$ to ensure that there are is no write $\bEv \in \aPS_2 \setminus \bPS$ such that $\bEv \xeco \aEv$.  Thus, $\aEv$ is $\reco$-minimal in $\aPS_2 \setminus \bPS$.  Result follows from induction hypothesis by considering $(\aPS_2,\bPS_1)$ where $\bPS_1$ is got from $\bPS$ by adding $\aEv$.  


So, we can assume that  all events in $\aPS \setminus \bPS$, say $\aEv_0, \ldots, \aEv_n$  that are minimal wrt $\rhb$ are reads, and we have  events 
$\aEv'_0, \aEv'_1, \ldots, \aEv'_n, \aEv_0$ such that:
\[
\begin{array}{lrl}
\aEv_i \xpox\ \aEv'_i \\
\aEv'_i \  (\reco\ \cup \lt)  \ \aEv_{(i+1)\mod n}
\end{array}
\]
Let $\bEv$ be the matching write for $\aEv_{(i+1)\mod n}$. If $\bEv_i \in \bPS$bEv , then by $\reco$ prefix closure of $\bPS$, $\bEv \xeco\ \aEv'_i$ and $\aEv_{(i+1)\mod n} \reco\ \aEv'_i$, which is a contradiction to $\reco$ being a total order per location.  So, we can assume that $\aEv'_i \  \lt  \ \aEv_{(i+1)\mod n}$. 

We proceed as follows.  We use lemma~\ref{inputen} on the  pomset $\aPS$ and read $\aEv_{(i+1)\mod n}$ and write $\aEv'_i$ to construct $\cPS$ that changes the value read in $\aEv_{j}$ to a value from $\bPS$.  $\dPS$  is derived adding the modified read yielded by lemma~\ref{inputen} to $\bPS$.  Result follows by induction hypothesis since $\dPS$ is a prefix of $\cPS$ under all of $\xpox,\lt, \reco$,  $\cPS$ has a race, and $\size(\dPS) = \size(\bPS) + 1$. 


\endinput

\section{Proof of DRF}

For any $\aPS$, then $\closed(\aPS)$ is set enriched with useless reads
(preserving augmentation closure) and where we remove any event whose
precondition is not a tautology.

For top level programs:
\begin{displaymath}
  \semClosed{\VAR\vec{\aLoc}\SEMI
    \vec{\aLoc}\GETS\vec{0}\SEMI
    \vec{\bLoc}\GETS\vec{0}\SEMI
    \FENCE\SEMI
    (\aCmd^1 \PAR \cdots \PAR \aCmd^n)}
  =
  \VAR\vec{\aLoc}\SEMI
    \vec{\aLoc}\GETS\vec{0}\SEMI
    \vec{\bLoc}\GETS\vec{0}\SEMI
    \FENCE\SEMI
    (\semClosed{\aCmd^1} \PAR \cdots \PAR \semClosed{\aCmd^n})
\end{displaymath}

\begin{definition}
A thread: top level component of a parallel composition
\end{definition}

\begin{definition}
$\aPS$ is a generator of  $\semClosed{\aCmd}$ if for all $\bPS \in \semClosed{\aCmd}$ such that $\aPS$ augments $\bPS$, $\aPS = \bPS$.
\end{definition}


Since the program we consider are loop free, for any command $\aCmd$, the size of the pomsets in $\aCmd$ are bounded by a constant, that we denote by $\size(\aCmd)$.  
 

\section{Generators for semantics of programs with parallel composition}
All generators $\aPS$  satisfy the following factorization of cross-thread $\lt$.  

\begin{lemma}\label{pargen}
Consider the subset of pomsets of $\semClosed{\aCmd \PAR \bCmd}$ that are  $\aLoc$-closed for all $\aLoc$.  

Let $\aPS$  be any generator.  
%\begin{itemize}
% \item
 Let $\aEv\lt\bEv$ and $\aEv \in \semClosed{\aCmd}$ and  $\bEv \in \semClosed{\bCmd} $.
  
Then there is a write  $\aEv' \in \semClosed{\aCmd}$, and  a read $\bEv' \in \semClosed{\bCmd}$ such that  $\bEv'$ reads-from $\aEv'$ and $\aEv \lt \aEv' \lt \bEv' \lt \bEv$. 

%\item $\aEv \gtN \bEv$ only if $ \aEv  [\lt \cup (\le; \reco;\le)^{\star}]  
%\bEv$.

% \item If $\aEv\lt\bEv$ and $\aEv, \bEv \in \semClosed{\aCmd}$, 
%then there exists 

%There exists a release action $\aEv'$ in $\sem{\aCmd}$, a 
%matching acquire action $\bEv'$ in $\sem{\bCmd}$ such that $
%\aEv \lt \aEv'$, $\bEv' \lt \bEv$ and $\aEv' \lt \bEv'$.

\end{lemma}








The proof of lemma~\ref{cohsat} yields the following two corollaries.
\begin{corollary}\label{cohrw}
Let $\aPS \in \sem{\aCmd}$ be a generator. Let 
\begin{itemize}
\item $\bEv'$ be a read from $\aLoc$ with matching write $\bEv$.  \item $\aEv$ be a write to $\aLoc$ such that  $\bEv' \gtN \aEv$.   \item Forall writes $\cEv$ to $\aLoc$ such that  $ \bEv \gtN \cEv \gtN  \aEv$,  it is the case that  $ \neg(\bEv' \lt \cEv)$ and $\neg(\bEv \xpox \cEv) ]$
\end{itemize}

Then, there exists $\bPS \in \sem{\aCmd}$, also a generator, such that $\Event_{\aPS} = \Event_{\bPS}$, $\le_{\aPS} = \le_{\bPS}$, and $\aEv \gtN \bEv'$ in $\bPS$.
\end{corollary}
\begin{corollary}\label{cohwr}
Let $\aPS \in \sem{\aCmd}$ be a generator. Let 
\begin{itemize}
\item $\aEv'$  read from $\aLoc$ with matching write $\aEv$. 
\item $\bEv$ be a  write to $\aLoc$ such that  $\bEv \gtN \aEv'$.  \item Forall writes $\cEv$ to $\aLoc$ such that  $ \bEv \gtN \cEv \gtN  \aEv$ and $\cEv \not= \aEv$,  it is the case that  $ \neg(\cEv \lt \aEv')$ and $\neg(\cEv \xpox \aEv) ]$. 
\end{itemize}

Then, there exists $\bPS \in \sem{\aCmd}$, also a generator, such that:
$\Event_{\aPS} = \Event_{\bPS}$, $\le_{\aPS} = \le_{\bPS}$, and 
$\aEv' \gtN \bEv$ in $\bPS$.  

\end{corollary}
        

===============good lemma. Not used. ==================




\begin{definition}
$ \aEv \xeco  \bEv$ if both $\aEv$ and $\bEv$ touch the same location, at least one is a write, and $\aEv \xird \bEv$  or $\aEv \xrb \bEv$ or $\aEv\xird \bEv$ or $\bEv \gtN \aEv$.
\end{definition}



