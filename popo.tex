\section{Weak Ideas}
Introduce \emph{weak order} $\wle$\footnote{Note we can \emph{not} require
\begin{itemize}
\item if $\bEv\;({\le}\cup{\wle})\;\aEv$ then $\labelingSub(\bEv)$ subsumes
  $\labelingSub(\aEv)$.
\end{itemize}
This does not hold, for example, in $\sem{x\GETS1\SEMI x\GETS2}$.}.

\begin{definition}[2.1]
  A \emph{(memory order) pomset} is a tuple
  $(\Event, {\le}, {\wle}, \labeling,{\xrmw})$: 
  \begin{itemize}
  \item $\Event$ is a set of \emph{states},
  \item ${\le}\subseteq (\Event\times\Event)$ and ${\wle}\subseteq (\Event\times\Event)$ are partial orders, 
  \item $\labeling: \Event \fun (\Formulae\times\Act)$ is a \emph{labeling},
    from which we derive functions $\labelingForm:\Event\fun\Formulae$ and $\labelingAct:\Event\fun\Act$,
  % \item $\labeling: \Event \fun (\Formulae\times\Act\times\Sub)$ is a \emph{labeling},
  %   from which we derive functions $\labelingForm:\Event\fun\Formulae$, $\labelingAct:\Event\fun\Act$, and  $\labelingSub:\Event\fun\Sub$,
  \item if $\bEv\;({\le}\cup{\wle})\;\aEv$ then $\labelingForm(\aEv)$ implies $\labelingForm(\bEv)$, and
  % \item $\bigwedge\{\labelingForm(\aEv_i)\mid\forall i,j.\; \aEv_i\xpox\aEv_j \textor \aEv_j\xpox\aEv_i\}$ is satisfiable.
  \item $\bigwedge_{\aEv}\labelingForm(\aEv)$ is satisfiable.
  \end{itemize}
  Additional stuff:
  \begin{itemize}
  \item if $\bEv\;({\le}\sequence{\wle})\;\aEv$ then $\bEv\neq\aEv$, and
  % \item if $\bEv\le\aEv$ and $\bEv$ and $\aEv$ conflict, then $\bEv\wle\aEv$,
  %\item if $\bEv\wle\aEv$ and $\bEv$ and $\aEv$ are SC, then $\bEv\le\aEv$,
  \item if $\bEv\;({\le}\sequence{\wlt}\sequence{\le})\;\aEv$, $\bEv$ is SC,
    and $\aEv$ is SC, then $\bEv\lt\aEv$.
  \end{itemize}
  RMW:
  \begin{itemize}
  \item If $\bEv\xrmw\aEv$, then $\bEv\le\aEv$.
  \item If $\cEv$, $\aEv$ write the same $x$, $\cEv\wle \aEv$ and $\bEv \xrmw \aEv$ then  $\cEv\wle \bEv$.
  \item If $\cEv$, $\aEv$ write the same $x$, $\bEv\wle \cEv$ and $\bEv \xrmw \aEv$ then  $\aEv\wle \cEv$.
  \end{itemize}  
\end{definition}
Update the definitions to use $\wle$ instead of $\le$ in two places:
\begin{itemize}
\item the last item defining fulfillment, and
\item item 5b defining prefixing.
\end{itemize}

\begin{definition}[2.4]
  We say $\bEv$ \emph{fulfills $\aEv$ on $\aLoc$} if 
  \begin{itemize}    
  \item $\bEv$ writes
    $\aVal$ to $\aLoc$, 
  \item $\aEv$ reads $\aVal$ from $\aLoc$,
  \item
    $\bEv \le \aEv$, and
  \item
    if $\cEv$ writes to $\aLoc$ then either $\cEv \wle \bEv$ or $\aEv \wle \cEv$.
  \end{itemize}
\end{definition}

\begin{definition}[2.10]
  \label{def:prefix}
Let $(\aForm \mid \aAct) \prefix \aPSS$ be the set $\PRE(\aPSS')$ where
$\aPS'\in\aPSS'$ when
there is some $\aPS\in\aPSS$ that satisfies items 1-4 of
Definition 2.8 %\ref{def:pre-sc}
such that:
\begin{enumerate}
\item[5a.]  if $\aEv$ writes then either $\bEv\le'\aEv$ or
  $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)$,
\item[5b.] if $\bEv$ and $\aEv$ are actions in conflict, then $\bEv\wle'\aEv$,
\item[5c.] if $\bEv$ is an acquire or $\aEv$ is a release, then $\bEv \le' \aEv$, and
\item[5d.] if $\bEv$ is an SC write and $\aEv$ is an SC read, then $\bEv \le' \aEv$.
\end{enumerate}
\end{definition}


Weak order is only required to relate actions on the same location.  In
augmentation minimal pomsets, it is a subset of $\reco$ (only relates writes
that are read).  The irreflexivity requirement in the definition is thus
comparable to requiring that ${\le}\cup({\wle}\restrict{\aLoc})$ is a partial
order, for every $\aLoc$.  It is \emph{not} the case that ${\le}\cup{\wle}$
is a partial order.

With the requirements of fulfillment, we have that $\bEv\le\aEv$ implies
$\bEv\wle\aEv$ when the actions conflict---there is a caveat for unread
writes, where no order is forced.

Here are some examples of the main text.  To better visualize, we use
different arrowheads for strong and weak order.  We use a single color for
strong order, and separate colors for each variable in weak order.

\tikzstyle{po} = [-latex,color=black,]
\tikzstyle{rf} = [-latex,color=black,]

Coherence C does not allow:
\begin{gather*}
  x\GETS1\SEMI x\GETS 2
  \PAR
  y\GETS x \SEMI z\GETS x
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a}{\DW{x}{1}}{}
      \event{b}{\DW{x}{2}}{right=of a}
      \wkx{a}{b}
      \event{c}{\DR{x}{2}}{right=2em of b}
      \event{d}{\DW{y}{2}}{right=of c}
      \po{c}{d}
      \event{e}{\DR{x}{1}}{right=of d}
      \event{f}{\DW{z}{1}}{right=of e}
      \po{e}{f}
      \rf{b}{c}
      \rf[out=10,in=170]{a}{e}
    \end{tikzinline}}
\end{gather*}

Coherence Java allows:
\begin{gather*}
  x\GETS1\SEMI y^\modeRA\GETS 1
  \PAR
  x\GETS 2\SEMI
  r\GETS y^\modeSC \SEMI 
  r\GETS x \SEMI 
  r\GETS x
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a}{\DW{x}{1}}{}
      \event{b}{\DW[\modeRA]{y}{1}}{right=of a}
      \po{a}{b}
      \event{c}{\DW{x}{2}}{below=of a}
      \event{d}{\DR[\modeSC]{y}{1}}{right=of c}
      \po{c}{d}
      \event{e}{\DR{x}{2}}{right=of d}
      \po{d}{e}
      \event{f}{\DR{x}{1}}{right=of e}
      \po[out=10,in=170]{d}{f}
      \rf{b}{d}
      %\rf[out=-10,in=-170]{c}{e}
      \wkx{a}{c}
      %\rf[out=15,in=150]{a}{f}
      \wkx[out=-165,in=-15]{f}{c}
    \end{tikzinline}}
\end{gather*}
Store buffering
\begin{gather*}
  x\GETS0\SEMI
  y\GETS0\SEMI
  (
  x\REL\GETS1\SEMI\aReg\GETS y
  \PAR
  y\REL\GETS1\SEMI \aReg\GETS x)
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{wx0}{\DW{x}{0}}{}
      \event{wy0}{\DW{y}{0}}{below=of wx0}
      \event{wx}{\DWRel{x}{1}}{right=of wx0}
      \event{wy}{\DWRel{y}{1}}{right=of wy0}
      \event{ry}{\DR{y}{0}}{right=of wx}
      \event{rx}{\DR{x}{0}}{right=of wy}
      \wkx{wx0}{wx}
      \wky{wy0}{wy}
      \po{wy}{rx}
      \po{wx}{ry}
      \rf{wy0}{ry}
      \rf{wx0}{rx}
      \wky{ry}{wy}
      \wkx{rx}{wx}
      % \po{rx}{wy}
    \end{tikzinline}}
\end{gather*}

IRIW
\begin{gather*}
  \renewcommand{\arraycolsep}{1pt}
  \begin{array}{ccccc}
    &x\GETS0\SEMI x\GETS 1
    &\PAR&
    r\GETS x\ACQ \SEMI s\GETS y
    %\IF{x}\THEN r\GETS y \FI
    \\
    \PAR
    &y\GETS0\SEMI y\GETS 1
    &\PAR&
    r\GETS y\ACQ \SEMI s\GETS x
    %\IF{y}\THEN s\GETS x \FI
  \end{array}
  \\
  \hbox{\begin{tikzinline}[baseline=-10pt,node distance=.5em and 1em]
  \event{wx0}{\DW{x}{0}}{}
  \event{wx1}{\DW{x}{1}}{right=of wx0}
  \event{wy0}{\DW{y}{0}}{below=2ex of wx0}
  \event{wy1}{\DW{y}{1}}{right=of wy0}
  \event{ry1}{\DRAcq{y}{1}}{right=2.5em of wy1}
  \event{rx0}{\DR{x}{0}}{right=of ry1}
  \event{rx1}{\DRAcq{x}{1}}{right=2.5 em of wx1}
  \event{ry0}{\DR{y}{0}}{right=of rx1}
  \wkx{wx0}{wx1}
  \wky{wy0}{wy1}
  \rf{wx1}{rx1}
  \rf[bend left]{wy0}{ry0}
  \rf{wy1}{ry1}
  \rf[bend right]{wx0}{rx0}
  \wkx{rx0}{wx1}
  \wky{ry0}{wy1}
  \po{rx1}{ry0}
  \po{ry1}{rx0}
    \end{tikzinline}}
\end{gather*}

Three variable \mca\ example Allowed.
\begin{gather*}
  \hbox{\small$\IF{x}\THEN y\GETS0 \FI \SEMI y\GETS1
  {\PAR}
  \IF{y}\THEN z\GETS0 \FI \SEMI z\GETS1
  {\PAR}
  \IF{z}\THEN x\GETS0 \FI \SEMI x\GETS1
  $}
  \\[-.5ex]
  \hbox{\begin{tikzinlinesmall}[node distance=1em]
  \event{a1}{\DR{x}{1}}{}
  \event{a2}{\DW{y}{0}}{right=of a1}
  \po{a1}{a2}
  \event{a3}{\DW{y}{1}}{right=of a2}
  \wky{a2}{a3}
  \event{b1}{\DR{y}{1}}{right=of a3}
  \event{b2}{\DW{z}{0}}{right=of b1}
  \po{b1}{b2}
  \event{b3}{\DW{z}{1}}{right=of b2}
  \wkz{b2}{b3}
  \event{c1}{\DR{z}{1}}{right=of b3}
  \event{c2}{\DW{x}{0}}{right=of c1}
  \po{c1}{c2}
  \event{c3}{\DW{x}{1}}{right=of c2}
  \wkx{c2}{c3}
  \rf{a3}{b1}
  \rf{b3}{c1}
  \rf[out=173,in=7]{c3}{a1}  
    \end{tikzinlinesmall}}
\end{gather*}
Two variable \mca\ example Allowed.
\begin{gather*}
  \hbox{\small$\IF{x}\THEN y\GETS0 \FI \SEMI y\GETS1
  {\PAR}
  \IF{y}\THEN x\GETS0 \FI \SEMI x\GETS1
  $}
  \\[-.5ex]
  \hbox{\begin{tikzinlinesmall}[node distance=1em]
  \event{a1}{\DR{x}{1}}{}
  \event{a2}{\DW{y}{0}}{right=of a1}
  \po{a1}{a2}
  \event{a3}{\DW{y}{1}}{right=of a2}
  \wky{a2}{a3}
  \event{b1}{\DR{y}{1}}{right=of a3}
  \event{b2}{\DW{x}{0}}{right=of b1}
  \po{b1}{b2}
  \event{b3}{\DW{x}{1}}{right=of b2}
  \wkx{b2}{b3}
  \rf{a3}{b1}
  \rf[out=173,in=7]{b3}{a1}  
    \end{tikzinlinesmall}}
\end{gather*}

\cite[Fig.~5]{DBLP:conf/pldi/LahavVKHD17}
\begin{gather*}
    x\GETS1
    \PAR
    r\GETS x\SEMI   
    \FENCE^{\modeSC}\SEMI
    r\GETS y  
    \PAR
    y\GETS 1 \SEMI
    \FENCE^{\modeSC}\SEMI
    r\GETS x  
    \\[-.1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
  \event{a1}{\DW{x}{1}}{}
  \event{b1}{\DR{x}{1}}{right=3em of a1}
  \event{b2}{\DFS{\modeSC}}{right=of b1}
  \po{b1}{b2}
  \event{b3}{\DR{y}{0}}{right=of b2}
  \po{b2}{b3}
  \event{c1}{\DW{y}{1}}{right=3em of b3}
  \event{c2}{\DFS{\modeSC}}{right=of c1}
  \po{c1}{c2}
  \event{c3}{\DR{x}{0}}{right=of c2}
  \po{c2}{c3}
  \wky{b3}{c1}
  \rf{a1}{b1}
  \wkx[out=-170,in=-10]{c3}{a1}
  \po[in=170,out=10]{b2}{c2}
    \end{tikzinline}}
\end{gather*}

\cite[Fig.~6]{DBLP:conf/pldi/LahavVKHD17}
\begin{gather*}
x\GETS1\SEMI   
    z\REL\GETS1\SEMI   
    \PAR
    r\ACQ\GETS z\SEMI   
    \FENCE^{\modeSC}\SEMI
    r\GETS y  
    \PAR
    y\GETS 1 \SEMI
    \FENCE^{\modeSC}\SEMI
    r\GETS x  
    \\[-.1ex]
  \hbox{\begin{tikzinline}[node distance=.7em]
  \event{a1}{\DW{x}{1}}{}
  \event{a2}{\DWRel{z}{1}}{right=of a1}
  \po{a1}{a2}
  \event{b1}{\DRAcq{z}{1}}{right=2em of a2}
  \event{b2}{\DFS{\modeSC}}{right=of b1}
  \po{b1}{b2}
  \event{b3}{\DR{y}{0}}{right=of b2}
  \po{b2}{b3}
  \event{c1}{\DW{y}{1}}{right=2em of b3}
  \event{c2}{\DFS{\modeSC}}{right=of c1}
  \po{c1}{c2}
  \event{c3}{\DR{x}{0}}{right=of c2}
  \po{c2}{c3}
  \wky{b3}{c1}
  \rf{a2}{b1}
  \wkx[out=-170,in=-10]{c3}{a1}
  \po[in=170,out=10]{b2}{c2}
    \end{tikzinline}}
\end{gather*}

PSC is part of AR
\cite[Ex.~3.9]{DBLP:journals/pacmpl/PodkopaevLV19}:
\begin{gather*}
  r\GETS y\SEMI
  \FENCE^{\modeSC}\SEMI
  r\GETS z
  \PAR
  z\GETS 1\SEMI
  \FENCE^{\modeSC}\SEMI
  r\GETS x
  \PAR
  \IF{x{\neq}0}\THEN y\GETS1 \FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{y}{1}}{}
      \event{a2}{\DFS{\modeSC}}{right=of a1}
      \event{a3}{\DR{z}{0}}{right=of a2}
      \po{a1}{a2}
      \po{a2}{a3}
      \event{b1}{\DW{z}{1}}{right=2em of a3}
      \event{b2}{\DFS{\modeSC}}{right=of b1}
      \event{b3}{\DR{x}{1}}{right=of b2}
      \po{b1}{b2}
      \po{b2}{b3}
      \event{c1}{\DR{x}{1}}{right=2em of b3}
      \event{c2}{\DW{y}{1}}{right=of c1}
      \po{c1}{c2}
      \wkz{a3}{b1}
      \rf{b3}{c1}
      \rf[out=-170,in=-10]{c2}{a1}
   \end{tikzinline}}
\end{gather*}
\cite[Ex.~3.2]{DBLP:journals/pacmpl/PodkopaevLV19}:
\begin{gather*}
  \aLoc\GETS0\SEMI\bReg\GETS \FADD^{\modeRLX,\modeRLX}(\aLoc)
  \PAR
  x\GETS 2\SEMI s\GETS x
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
  \event{a2}{\DR{x}{0}}{}
  \event{a1}{\DW{x}{0}}{left=of a2}
  \rf{a1}{a2}
  \event{a3}{\DW{x}{2}}{right=of a2}
  \wkx{a2}{a3}
  \event{b2}{\DW{x}{1}}{right=of a3}
  \event{b3}{\DR{x}{1}}{right=of b2}
  \rmw[out=-15,in=-165]{a2}[below]{b2}
  \wkx{a3}{b2}
  \rf{b2}{b3}
    \end{tikzinline}}
\end{gather*}

\cite[Ex.~3.10]{DBLP:journals/pacmpl/PodkopaevLV19} (Arm allows):
\begin{gather*}
  r \GETS y\SEMI
  z \GETS r
  \PAR
  r\GETS z\SEMI
  x\GETS 0\SEMI
  s\GETS \FADD^{\modeRLX,\modeRA}(x) \SEMI
  y\GETS s{+}1
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
  \event{a1}{\DR{y}{1}}{}
  \event{a2}{\DW{z}{1}}{right=of a1}
  \po{a1}{a2}
  \event{b1}{\DR{z}{1}}{right=3em of a2}
  \rf{a2}{b1}
  \event{b2}{\DW{x}{0}}{right=of b1}
  \event{b3}{\DR{x}{0}}{right=of b2}
  \rf{b2}{b3}
  \event{b4}{\DWRel{x}{1}}{right=2em of b3}
  \rmw{b3}{b4}
  \event{b5}{\DW{y}{1}}{right=of b4}
  \po[out=-15,in=-165]{b1}{b4}
  \po[out=-20,in=-160]{b3}{b5}
  \rf[out=170,in=10]{b5}{a1}
    \end{tikzinline}}
\end{gather*}


Detour Example 
\cite[Ex.~3.7]{DBLP:journals/pacmpl/PodkopaevLV19}:
\begin{gather*}
  x\GETS z-1\SEMI
  y\GETS x
  \PAR
  x\GETS1
  \PAR
  z\GETS y
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{b1}{\DR{z}{1}}{}
      \event{b2}{\DW{x}{0}}{right=of b1}
      \po{b1}{b2}
      \event{b3}{\DR{x}{1}}{right=of b2}
      \event{b4}{\DW{y}{1}}{right=of b3}
      \po{b3}{b4}
      \event{c1}{\DR{y}{1}}{right=2em of b4}
      \event{c2}{\DW{z}{1}}{right=of c1}
      \po{c1}{c2}
      \event{a1}{\DW{x}{1}}{below right=2ex and -2ex of b2}
      \rf{b4}{c1}
      \rf{a1}{b3}
      \wkx{b2}{a1} 
      \rf[out=170,in=10]{c2}{b1}
   \end{tikzinline}}
\end{gather*}

\cite[After example 3.6]{DBLP:journals/pacmpl/PodkopaevLV19}:
Note that we do not include fri in ppo since it is not preserved in ARMv7
[Alglave et al. 2014] (unlike in x86-TSO, POWER, and ARMv8). Thus, as ARMv7
(as well as the Flowing and POP models of ARM in [Flur et al. 2016]), IMM
allows the weak behavior from [Lahav and Vafeiadis 2016, §6].


\cite[Remark 2, After example 3.1]{DBLP:journals/pacmpl/PodkopaevLV19}: Aim:
allow the splitting of release writes and RMWs into release fences followed
by relaxed operations.  In RC11 [Lahav et al. 2017], as well as in C/C++11
[Batty et al. 2011], this rather intuitive transformation, as we found out,
is actually unsound.
\begin{gather*}
  y\GETS 1\SEMI
  x\REL\GETS 1
  \PAR
  r\GETS \FADD^{\modeRA,\modeRA}(x) \SEMI  %1
  x\GETS 3
  \PAR
  r\GETS x\ACQ \SEMI %3
  s\GETS y %0
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{y}{1}}{}
      \event{a2}{\DWRel{x}{1}}{right=of a1}
      \po{a1}{a2}
      \event{b1}{\DRAcq{x}{1}}{right=2em of a2}
      \event{b2}{\DWRel{x}{2}}{right=of b1}
      \rmw{b1}{b2}
      \event{b3}{\DW{x}{3}}{right=of b2}
      \wkx{b2}{b3}
      \event{c1}{\DR{x}{3}}{right=2em of b3}
      \event{c2}{\DR{y}{0}}{right=of c1}
      \po{c1}{c2}
      \rf{b3}{c1}
      \rf{a2}{b1}
      \wky[out=170,in=10]{c2}{a1}
   \end{tikzinline}}
\end{gather*}
(R)C11 disallows the annotated behavior, due in particular to the release sequence formed from the
release exclusive write to x in the second thread to its subsequent relaxed write. However, if we
split the increment to fencerel; a := FADDacq,rlx(x, 1) (which intuitively may seem stronger), the
release sequence will no longer exist, and the annotated behavior will be allowed. IMM overcomes
this problem by strengthening sw in a way that ensures a synchronization edge for the transformed
program as well
\begin{gather*}
  y\GETS 1\SEMI
  x\REL\GETS 1
  \PAR
  \FENCE^{\modeREL}\SEMI
  r\GETS \FADD^{\modeRA,\modeRLX}(x) \SEMI  %1
  x\GETS 3
  \PAR
  r\GETS x\ACQ \SEMI %3
  s\GETS y %0
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{y}{1}}{}
      \event{a2}{\DWRel{x}{1}}{right=of a1}
      \po{a1}{a2}
      \event{b0}{\DFS{\modeREL}}{right=2em of a2}
      \event{b1}{\DRAcq{x}{1}}{right=of b0}
      \event{b2}{\DW{x}{2}}{right=of b1}
      \rmw{b1}{b2}
      \event{b3}{\DW{x}{3}}{right=of b2}
      \wkx{b2}{b3}
      \event{c1}{\DR{x}{3}}{right=2em of b3}
      \event{c2}{\DR{y}{0}}{right=of c1}
      \po{c1}{c2}
      \rf{b3}{c1}
      \rf[out=-10,in=-170]{a2}{b1}
      \wky[out=170,in=10]{c2}{a1}
   \end{tikzinline}}
\end{gather*}
